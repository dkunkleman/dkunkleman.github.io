<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Like Charlie — Admin</title>
<style>
  body{margin:0;background:#0b1220;color:#e6eefc;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif}
  .wrap{max-width:1100px;margin:0 auto;padding:20px}
  h1{margin:0 0 12px}
  .row{display:flex;gap:8px;flex-wrap:wrap}
  table{width:100%;border-collapse:collapse;margin-top:12px}
  th,td{border-bottom:1px solid rgba(255,255,255,.12);padding:8px 6px;text-align:left}
  input,select{padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,.12);background:#0c1630;color:#e6eefc}
  .btn{padding:8px 12px;border:1px solid rgba(255,255,255,.12);border-radius:8px;background:#162552;color:#fff;text-decoration:none;display:inline-block}
  .badge{padding:2px 8px;border-radius:999px;border:1px solid rgba(255,255,255,.12)}
  .ok{background:#134e4a}
  .no{background:#5b1d2a}
</style>
</head>
<body>
<main class="wrap">
  <h1>Admin — Submissions</h1>
  <div class="row">
    <input id="filterText" placeholder="Search action/org/name/email…">
    <select id="filterApproved">
      <option value="all">All</option>
      <option value="true">Approved</option>
      <option value="false">Unapproved</option>
    </select>
    <a class="btn" href="/" target="_self">← Back to site</a>
  </div>
  <div id="totals" style="margin-top:10px"></div>
  <table>
    <thead>
      <tr><th>When</th><th>Action</th><th>URL</th><th>Donation</th><th>Name/Email</th><th>Approved</th><th>Toggle</th></tr>
    </thead>
    <tbody id="rows"></tbody>
  </table>
</main>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/supabase.js"></script>
<script>
(async function(){
  // Reuse keys from index.html if present; otherwise paste here temporarily.
  const URL  = window.SUPABASE_URL  || "";  // e.g. "https://YOURPROJECT.supabase.co"
  const KEY  = window.SUPABASE_ANON_KEY || "";
  if(!URL || !KEY){ alert('Missing SUPABASE_URL / SUPABASE_ANON_KEY'); return; }
  const db = window.supabase.createClient(URL, KEY);

  const rowsEl   = document.getElementById('rows');
  const totalsEl = document.getElementById('totals');
  const fText    = document.getElementById('filterText');
  const fApp     = document.getElementById('filterApproved');

  async function load(){
    let q = db.from('public_submissions').select('*').order('created_at',{ascending:false}).limit(500);
    if (fApp.value==='true')  q=q.eq('approved',true);
    if (fApp.value==='false') q=q.eq('approved',false);
    const { data } = await q;
    const text = (fText.value||'').toLowerCase();
    const view = (data||[]).filter(r=>{
      if(!text) return true;
      return [r.action,r.name,r.email,r.donation_org,(r.url||'')].some(v=>(v||'').toLowerCase().includes(text));
    });

    // totals
    const total = view.length;
    const donated = view.reduce((s,r)=> s + (parseFloat(r.donation_amt)||0), 0);
    totalsEl.innerHTML = `<span class="badge ok">Rows: ${total}</span> <span class="badge ok" style="margin-left:8px">Donations: $${donated.toFixed(2)}</span>`;

    // table
    rowsEl.innerHTML = view.map(r=>{
      const when = new Date(r.created_at).toLocaleString();
      const link = r.url ? `<a href="${r.url}" target="_blank" rel="noopener">open</a>` : '';
      const don  = (r.donation_org||r.donation_amt) ? `${r.donation_org||''} ${r.donation_amt?('$'+r.donation_amt):''}` : '';
      return `<tr>
        <td>${when}</td>
        <td>${r.action||''}</td>
        <td>${link}</td>
        <td>${don||''}</td>
        <td>${(r.name||'')}${r.email?(' • '+r.email):''}</td>
        <td>${r.approved?'<span class="badge ok">Yes</span>':'<span class="badge no">No</span>'}</td>
        <td><a href="#" class="btn" data-id="${r.id}" data-approved="${r.approved?'true':'false'}">${r.approved?'Unapprove':'Approve'}</a></td>
      </tr>`;
    }).join('') || `<tr><td colspan="7" class="muted">No rows.</td></tr>`;
  }

  rowsEl.addEventListener('click', async (e)=>{
    const a = e.target.closest('a[data-id]'); if(!a) return e.preventDefault();
    e.preventDefault();
    const id = a.getAttribute('data-id');
    const isApproved = a.getAttribute('data-approved')==='true';
    await db.from('public_submissions').update({approved: !isApproved}).eq('id', id);
    load();
  });

  fText.addEventListener('input', load);
  fApp.addEventListener('change', load);
  load();
})();
</script>
</body>
</html>
