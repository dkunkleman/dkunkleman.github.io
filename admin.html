<!doctype html>
<html lang="en">
<head>

  <meta name="robots" content="noindex">
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin · Live Like Charlie</title>
  <link rel="icon" href="/icons/icon-192.png">
  <link rel="manifest" href="/manifest.webmanifest">
  <style>
    body{font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; margin: 2rem; line-height:1.4}
    header{display:flex; align-items:center; gap:1rem; margin-bottom:1rem}
    .warn{background:#fff3cd; border:1px solid #ffe69c; padding:1rem; border-radius:8px; margin-bottom:1rem}
    table{border-collapse: collapse; width:100%}
    th, td{border:1px solid #ddd; padding:8px; vertical-align:top}
    th{background:#f7f7f7}
    button{padding:.4rem .7rem}
    .approved{color:#0a7a28; font-weight:600}
    .pending{color:#c1121f; font-weight:600}
    .grid{display:grid; grid-template-columns: repeat(2,1fr); gap:2rem}
    @media (max-width: 900px){ .grid{grid-template-columns: 1fr;} }
  </style>
  <script>
    // ***** SECURITY NOTE *****
    // This demo admin uses the public anon key from the browser.
    // Protect this page with HTTP auth and use Supabase RLS to ensure
    // only an "admin" role can update 'approved'. Ideally, move updates
    // to a serverless function that checks a token server-side.
    window.SUPABASE_URL = window.SUPABASE_URL || 'https://YOUR_PROJECT.supabase.co';
    window.SUPABASE_ANON_KEY = window.SUPABASE_ANON_KEY || 'YOUR_PUBLIC_ANON_KEY';
  </script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
  <header>
    <h1>Admin · Submissions</h1>
    <button id="refreshBtn">Refresh</button>
  </header>
  <div class="warn">
    <strong>Warning:</strong> Browser-side admin is for demo only. Lock this page down and/or move writes to serverless functions. Ensure RLS denies updates to anon users.
  </div>
  <div class="grid">
    <section>
      <h2>Pending</h2>
      <table>
        <thead><tr><th>When</th><th>User</th><th>Link</th><th>Action</th><th>Status</th></tr></thead>
        <tbody id="pendingBody"></tbody>
      </table>
    </section>
    <section>
      <h2>Approved (latest 50)</h2>
      <table>
        <thead><tr><th>When</th><th>User</th><th>Link</th><th>Action</th><th>Status</th></tr></thead>
        <tbody id="approvedBody"></tbody>
      </table>
    </section>
  </div>
  <script>
    const sb = supabase.createClient(window.SUPABASE_URL, window.SUPABASE_ANON_KEY);
    const format = (iso) => new Date(iso).toLocaleString();

    async function load(){
      // Pending
      const { data: pending, error: ep } = await sb
        .from('submissions')
        .select('id, created_at, user_handle, link, action_label, approved')
        .eq('approved', false)
        .order('created_at', { ascending: false })
        .limit(200);

      // Approved
      const { data: approved, error: ea } = await sb
        .from('submissions')
        .select('id, created_at, user_handle, link, action_label, approved')
        .eq('approved', true)
        .order('created_at', { ascending: false })
        .limit(50);

      if (ep) console.error(ep);
      if (ea) console.error(ea);
      renderTable('pendingBody', pending || [], false);
      renderTable('approvedBody', approved || [], true);
    }

    function renderTable(bodyId, rows, isApproved){
      const tbody = document.getElementById(bodyId);
      tbody.innerHTML = '';
      for(const r of rows){
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${format(r.created_at)}</td>
          <td>${r.user_handle ? '@'+r.user_handle : ''}</td>
          <td><a href="${r.link}" target="_blank" rel="noopener">open</a></td>
          <td>${r.action_label || ''}</td>
          <td>${r.approved ? '<span class="approved">approved</span>' : '<span class="pending">pending</span>'}
            ${!r.approved ? '<button data-id="'+r.id+'" class="approveBtn">Approve</button>' : ''}
            ${r.approved ? '<button data-id="'+r.id+'" class="unapproveBtn">Unapprove</button>' : ''}
          </td>
        `;
        tbody.appendChild(tr);
      }
      tbody.querySelectorAll('.approveBtn').forEach(btn => btn.addEventListener('click', () => updateApproval(btn.dataset.id, true)));
      tbody.querySelectorAll('.unapproveBtn').forEach(btn => btn.addEventListener('click', () => updateApproval(btn.dataset.id, false)));
    }

    async function updateApproval(id, approved){
      // This will only work if your RLS allows it for the current user/session.
      const { error } = await sb.from('submissions').update({ approved }).eq('id', id);
      if (error) {
        alert('Update failed: ' + error.message);
      } else {
        await load();
      }
    }

    document.getElementById('refreshBtn').addEventListener('click', load);
    load();
  </script>
</body>
</html>
